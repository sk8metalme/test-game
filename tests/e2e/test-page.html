<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetris Game - E2E Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #1a1a2e;
            color: white;
        }
        
        #game-container {
            width: 100%;
            height: 600px;
            background-color: #16213e;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #0f0f23;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .status {
            margin: 5px 0;
        }
        
        .status.success {
            color: #4CAF50;
        }
        
        .status.error {
            color: #f44336;
        }
        
        .status.warning {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <h1>Tetris Game - E2E Test Page</h1>
    <div id="game-container"></div>
    
    <div class="debug-info">
        <h3>デバッグ情報</h3>
        <div id="initialization-status" class="status">初期化中...</div>
        <div id="components-status" class="status">コンポーネント状態: 未確認</div>
        <div id="effects-status" class="status">エフェクトシステム: 未確認</div>
        <div id="performance-status" class="status">パフォーマンス: 測定中...</div>
        <div id="errors-status" class="status">エラー: なし</div>
    </div>

    <script type="module">
        // E2Eテスト用のデバッグ機能
        let debugInfo = {
            initializationComplete: false,
            componentsLoaded: false,
            effectsWorking: false,
            fps: 0,
            errors: []
        };

        // コンソールエラーをキャッチ
        window.addEventListener('error', (event) => {
            debugInfo.errors.push(event.error.message);
            updateDebugInfo();
        });

        // デバッグ情報更新
        function updateDebugInfo() {
            document.getElementById('initialization-status').textContent = 
                `初期化: ${debugInfo.initializationComplete ? '完了' : '進行中'}`;
            document.getElementById('initialization-status').className = 
                `status ${debugInfo.initializationComplete ? 'success' : 'warning'}`;
                
            document.getElementById('components-status').textContent = 
                `コンポーネント: ${debugInfo.componentsLoaded ? '読み込み完了' : '読み込み中'}`;
            document.getElementById('components-status').className = 
                `status ${debugInfo.componentsLoaded ? 'success' : 'warning'}`;
                
            document.getElementById('effects-status').textContent = 
                `エフェクト: ${debugInfo.effectsWorking ? '動作中' : '未確認'}`;
            document.getElementById('effects-status').className = 
                `status ${debugInfo.effectsWorking ? 'success' : 'warning'}`;
                
            document.getElementById('performance-status').textContent = 
                `FPS: ${debugInfo.fps.toFixed(1)}`;
            document.getElementById('performance-status').className = 
                `status ${debugInfo.fps >= 55 ? 'success' : 'warning'}`;
                
            document.getElementById('errors-status').textContent = 
                `エラー: ${debugInfo.errors.length > 0 ? debugInfo.errors.join(', ') : 'なし'}`;
            document.getElementById('errors-status').className = 
                `status ${debugInfo.errors.length === 0 ? 'success' : 'error'}`;
        }

        // パフォーマンス監視
        let frameCount = 0;
        let lastTime = performance.now();
        
        function measureFPS() {
            frameCount++;
            const currentTime = performance.now();
            
            if (currentTime - lastTime >= 1000) {
                debugInfo.fps = frameCount / ((currentTime - lastTime) / 1000);
                frameCount = 0;
                lastTime = currentTime;
                updateDebugInfo();
            }
            
            requestAnimationFrame(measureFPS);
        }
        measureFPS();

        // TetrisGameの初期化
        async function initializeGame() {
            try {
                const { default: TetrisGame } = await import('../../src/presentation/main.js');
                
                debugInfo.componentsLoaded = true;
                updateDebugInfo();
                
                const container = document.getElementById('game-container');
                window.tetrisGame = new TetrisGame(container);
                
                debugInfo.initializationComplete = true;
                updateDebugInfo();
                
                // エフェクトシステムの動作確認用のテストイベント発火
                setTimeout(() => {
                    if (window.tetrisGame && window.tetrisGame.eventEmitter) {
                        debugInfo.effectsWorking = true;
                        updateDebugInfo();
                    }
                }, 2000);
                
                // E2Eテスト用にグローバルに公開
                window.debugInfo = debugInfo;
                window.updateDebugInfo = updateDebugInfo;
                
            } catch (error) {
                debugInfo.errors.push(`初期化エラー: ${error.message}`);
                updateDebugInfo();
                console.error('Game initialization failed:', error);
            }
        }

        // 初期化開始
        initializeGame();
    </script>
</body>
</html>
