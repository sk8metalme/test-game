# テトリスゲーム テスト設計仕様書

## 概要

本ドキュメントは、HTML5 Canvas + JavaScript で実装されるテトリスゲームの包括的なテスト設計仕様を定義します。品質保証、性能要件、ユーザビリティ、堅牢性を確保するための体系的なテストアプローチを提供します。

## プロジェクト情報

- **プロジェクト名**: テトリス生成AI (test-game)
- **技術スタック**: HTML5 Canvas, Pure JavaScript
- **テストフレームワーク**: Jest + jsdom
- **対象ブラウザ**: Chrome, Firefox, Safari, Edge
- **品質目標**: カバレッジ80%以上、60fps安定動作

## テスト戦略概要

### テストピラミッド構造

```
        E2E / 統合テスト (10%)
           ↗            ↖
    統合テスト (20%)
         ↗      ↖
  ユニットテスト (70%)
```

### テストの種類と目的

| テスト種別 | 目的 | カバレッジ目標 | 実行頻度 |
|-----------|------|---------------|----------|
| ユニットテスト | 個別コンポーネントの機能検証 | 85%+ | CI/CD毎回 |
| 統合テスト | コンポーネント間連携の検証 | 80%+ | CI/CD毎回 |
| パフォーマンステスト | 性能要件の検証 | - | 日次 |
| エッジケーステスト | 境界条件・異常系の検証 | - | CI/CD毎回 |
| ブラウザ互換性テスト | 複数ブラウザでの動作検証 | - | リリース前 |

## コンポーネント別テスト設計

### 1. Board コンポーネント

**責任範囲**: 20x10ゲームボードの管理、ライン検出・削除、衝突判定

#### ユニットテスト項目

##### 初期化とセットアップ
- [ ] 20x10の空グリッドで初期化
- [ ] 全セルが初期状態で空
- [ ] ボードリセット機能

##### セル操作
- [ ] セル値の設定・取得
- [ ] 範囲外アクセスの安全な処理
- [ ] 無効な入力値の適切な処理

##### ライン検出と削除
- [ ] 完成ラインの正確な検出
- [ ] 複数ライン同時検出
- [ ] ライン削除後の上段ブロック落下
- [ ] テトリス（4ライン同時削除）の処理

##### 衝突検出
- [ ] 空セルでの非衝突判定
- [ ] 占有セルでの衝突検出
- [ ] ボード境界での衝突検出
- [ ] 複雑形状での精密な衝突判定

##### パフォーマンス要件
- [ ] セル操作: 1000回 < 10ms
- [ ] ライン検出: 100回 < 50ms
- [ ] 衝突検出: 1000回 < 1ms

### 2. Tetromino コンポーネント

**責任範囲**: テトロミノピースの形状管理、回転、位置制御

#### ユニットテスト項目

##### ピース生成
- [ ] 全7種類の正確な形状生成
- [ ] 適切な色割り当て
- [ ] デフォルト位置での初期化

##### 回転機能
- [ ] 時計回り・反時計回りの回転
- [ ] 4回転での元形状復帰
- [ ] O字ピースの回転不変性
- [ ] I字ピースの2状態回転

##### Wall Kick システム
- [ ] 境界近傍での回転補正
- [ ] キック失敗時の状態保持
- [ ] I字ピース特殊キックパターン

##### 位置管理
- [ ] 上下左右の移動
- [ ] 特定座標への設定
- [ ] ハードドロップ機能
- [ ] ゴーストピース位置計算

##### エラーハンドリング
- [ ] 無効なピースタイプでのエラー
- [ ] 無効位置設定の安全な処理

### 3. Game コンポーネント

**責任範囲**: ゲーム全体の状態管理、ロジック制御、スコアリング

#### ユニットテスト項目

##### ゲーム状態管理
- [ ] MENU → PLAYING → PAUSED → GAME_OVER の状態遷移
- [ ] 不正な状態遷移の防止
- [ ] ゲームリセット機能

##### ピース管理
- [ ] 新ピースのスポーン
- [ ] 7-bagランダマイザー
- [ ] ピースロック遅延処理
- [ ] スポーン衝突でのゲームオーバー

##### スコアリングシステム
- [ ] ライン削除数別スコア計算
  - シングル: 100点
  - ダブル: 300点
  - トリプル: 500点
  - テトリス: 800点
- [ ] レベル倍率の適用
- [ ] ソフト/ハードドロップスコア

##### レベル進行
- [ ] ライン数によるレベルアップ
- [ ] 落下速度の調整
- [ ] 最大レベル制限

#### 統合テスト項目

##### ゲームフロー全体
- [ ] 開始 → プレイ → 終了の完全フロー
- [ ] ピース操作からスコア反映まで
- [ ] ライン削除とレベルアップの連動

##### 入力処理統合
- [ ] キーボード入力の即座反映
- [ ] 入力リピート（DAS）の動作
- [ ] ゲーム状態による入力制限

### 4. Renderer コンポーネント

**責任範囲**: Canvas描画、アニメーション、UI表示

#### ユニットテスト項目

##### 基本描画
- [ ] ゲームボードグリッドの描画
- [ ] アクティブピースの描画
- [ ] 固定ピースの描画
- [ ] ゴーストピースの半透明描画

##### UI要素
- [ ] スコア、レベル、ライン数表示
- [ ] ネクストピースプレビュー
- [ ] ゲーム状態メッセージ

##### アニメーション
- [ ] ライン削除エフェクト
- [ ] ピース落下の滑らかな補間
- [ ] レベルアップ・テトリスエフェクト

##### レスポンシブ対応
- [ ] 画面サイズ変更への対応
- [ ] 高DPI画面での描画品質
- [ ] モバイル向け調整

#### パフォーマンス要件
- [ ] フレームレンダリング: < 16.67ms (60fps)
- [ ] 複雑ボード描画: < 10ms
- [ ] メモリ使用量安定性

### 5. Controls コンポーネント

**責任範囲**: キーボード入力処理、入力マッピング

#### ユニットテスト項目

##### 入力マッピング
- [ ] 矢印キー → 移動・回転のマッピング
- [ ] スペースキー → ハードドロップ
- [ ] Pキー → ポーズ/再開

##### 入力処理
- [ ] キーリピート（DAS）処理
- [ ] 同時押し入力の処理
- [ ] 無効キーの安全な無視

##### 応答性
- [ ] 入力遅延: < 16ms
- [ ] 連続入力の正確な処理

## パフォーマンステスト設計

### 目標指標

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| フレームレート | 安定60fps | 5秒間連続測定 |
| 入力遅延 | < 16ms | 1000回平均 |
| メモリ使用量 | < 50MB | 長時間実行後 |
| 起動時間 | < 1秒 | 初期化完了まで |
| 衝突検出 | < 1ms | 1000回平均 |

### ベンチマークテスト

#### ゲームロジック性能
```javascript
describe('ゲームロジック性能', () => {
  test('衝突検出: 1000回 < 1ms平均', () => {
    // 大量の衝突検出実行
    // 平均実行時間を測定
  });
  
  test('ライン削除: 100回 < 100ms', () => {
    // 複数ライン削除処理の実行時間測定
  });
});
```

#### レンダリング性能
```javascript
describe('レンダリング性能', () => {
  test('60フレーム描画 < 1000ms', () => {
    // 連続60フレーム描画の実行時間測定
  });
  
  test('複雑ボード描画性能', () => {
    // 高密度ボード状態での描画性能測定
  });
});
```

#### メモリ効率性
```javascript
describe('メモリ使用量', () => {
  test('長時間実行でのメモリ安定性', () => {
    // 10000回更新後のメモリ使用量測定
  });
  
  test('複数セッションでのメモリリーク検出', () => {
    // ゲーム作成・破棄の繰り返し
  });
});
```

## エッジケース・境界条件テスト

### 境界値テスト

#### ボード境界
- [ ] 左端(x=0)、右端(x=9)での移動制限
- [ ] 上端(y=0)、下端(y=19)での移動制限
- [ ] 角位置(0,0), (9,19)での回転処理

#### 数値境界
- [ ] 最大スコア(MAX_SAFE_INTEGER)での加算処理
- [ ] 最大レベルでの処理
- [ ] 負の値入力の処理

#### 極端な状態
- [ ] 空ボードでの処理
- [ ] 完全に埋まったボードでの処理
- [ ] 全20ライン同時削除

### 異常系テスト

#### 無効入力
- [ ] null, undefined, NaN値の処理
- [ ] 型違いパラメータの処理
- [ ] 範囲外座標の処理

#### 同時発生イベント
- [ ] ピース固定 + ライン削除
- [ ] ゲームオーバー + ライン削除
- [ ] レベルアップ + ライン削除
- [ ] ポーズ + 入力処理

#### リソース制限
- [ ] 長時間実行での安定性
- [ ] 大量オブジェクト生成
- [ ] 深い再帰処理の制限

### ブラウザ環境対応

#### API対応状況
- [ ] requestAnimationFrame未対応
- [ ] Canvas API未対応
- [ ] localStorage未対応

#### 性能制限
- [ ] 低性能デバイスでの動作
- [ ] 高DPI画面での性能
- [ ] モバイル環境での制約

## テスト実行戦略

### 継続的インテグレーション

#### CI/CDパイプライン
```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm test              # ユニット・統合テスト
      - run: npm run test:performance # パフォーマンステスト
      - run: npm run test:e2e      # E2Eテスト
```

#### 実行頻度
- **プルリクエスト**: 全テストスイート実行
- **main ブランチ**: 全テスト + パフォーマンス測定
- **リリース前**: 全テスト + ブラウザ互換性テスト

### テストデータ管理

#### テストシナリオ
```javascript
export const TEST_SCENARIOS = {
  TETRIS_SETUP: {
    board: [/* 4ライン削除可能な配置 */],
    nextPieces: ['I', 'O', 'T']
  },
  NEAR_GAME_OVER: {
    board: [/* ゲームオーバー直前の状態 */],
    nextPieces: ['S', 'Z', 'L']
  }
};
```

#### テストユーティリティ
```javascript
export const TestUtils = {
  createMockCanvas: () => { /* Canvas モック作成 */ },
  createMockBoard: (pattern) => { /* ボードパターン作成 */ },
  simulateKeyPress: (key) => { /* キー入力シミュレート */ },
  validateGameState: (state) => { /* ゲーム状態検証 */ }
};
```

## カバレッジ要件

### コードカバレッジ目標

| コンポーネント | ライン | ブランチ | 関数 | ステートメント |
|---------------|--------|----------|------|---------------|
| Board.js | 90% | 85% | 90% | 90% |
| Tetromino.js | 90% | 85% | 90% | 90% |
| Game.js | 90% | 90% | 90% | 90% |
| Renderer.js | 80% | 75% | 80% | 80% |
| Controls.js | 85% | 80% | 85% | 85% |
| **全体** | **85%** | **80%** | **85%** | **85%** |

### 機能カバレッジ

#### 必須機能 (100%カバレッジ)
- [ ] ピース移動・回転
- [ ] ライン削除
- [ ] スコア計算
- [ ] ゲーム状態管理
- [ ] 衝突検出

#### 重要機能 (90%カバレッジ)
- [ ] Wall Kick システム
- [ ] レベル進行
- [ ] アニメーション
- [ ] 入力処理

#### 補助機能 (80%カバレッジ)
- [ ] 統計表示
- [ ] 設定保存
- [ ] エラーハンドリング

## 品質ゲート基準

### リリース判定基準

#### 機能要件
- [ ] 全ユニットテスト合格
- [ ] 統合テスト合格
- [ ] ゲームプレイが完全に動作

#### 性能要件
- [ ] 60fps安定動作
- [ ] 入力遅延 < 16ms
- [ ] メモリ使用量 < 50MB

#### 品質要件
- [ ] コードカバレッジ > 85%
- [ ] 重大バグ 0件
- [ ] 全対象ブラウザで動作

#### ユーザビリティ要件
- [ ] 直感的な操作性
- [ ] 明確な視覚フィードバック
- [ ] 滑らかなアニメーション

## テスト環境

### 開発環境
- **OS**: macOS, Windows, Linux
- **Node.js**: v18+
- **ブラウザ**: Chrome 最新版
- **テストランナー**: Jest v29+

### CI環境
- **プラットフォーム**: GitHub Actions (Ubuntu)
- **並列実行**: 4スレッド
- **タイムアウト**: 30分

### ブラウザテスト環境
- **Chrome**: v110+
- **Firefox**: v110+
- **Safari**: v16+
- **Edge**: v110+
- **モバイル**: Chrome Mobile, Safari Mobile

## 成功指標

### 開発効率
- [ ] テスト実行時間 < 5分
- [ ] 新機能テスト作成時間 < 1時間
- [ ] バグ検出率 > 90%

### 品質指標
- [ ] 本番バグ発生率 < 1%
- [ ] ユーザー報告バグ < 月1件
- [ ] パフォーマンス回帰 0件

### 保守性
- [ ] テストコード可読性評価 > 4.0/5.0
- [ ] 新規参加者のテスト理解時間 < 2時間
- [ ] テストメンテナンス時間 < 開発時間の20%

## 今後の拡張

### 将来的なテスト拡張項目
- [ ] ビジュアル回帰テスト（画像比較）
- [ ] アクセシビリティテスト
- [ ] モバイル固有のテスト
- [ ] マルチプレイヤー機能のテスト
- [ ] AI対戦機能のテスト

### 自動化の強化
- [ ] テストデータ自動生成
- [ ] 性能レポート自動生成
- [ ] 障害発生時の自動解析
- [ ] テストケース優先度の動的調整

---

このテスト設計仕様書に基づいて、高品質で堅牢なテトリスゲームの開発と保守を行ってください。定期的にテスト結果を確認し、必要に応じて仕様を更新してください。
